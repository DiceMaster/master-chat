<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="css/default.css">    
    <title>MasterChat</title>
</head>
<body>
<div id="chat_container">
    <div id="message_list" class="big-smiles animated-smiles">
    </div>
</div>
<script type="module">
    import {AppLifeCycleService} from '/js/appLifeCycleService.js';
    import {ConfigSource} from '/js/configSource.js';
    import {RankController} from '/js/rankController.js';
    import {ChatSource} from '/js/chatSource.js';
    import {ChatWindowViewController} from '/js/controllers/chatWindowViewController.js';
    import {CommandController} from '/js/commandController.js';
    import {RankedQueueService} from '/js/rankedQueueService.js';
    import {GiveawayService} from '/js/giveawayService.js';
    import {RankedQueueViewController} from '/js/controllers/rankQueueViewController.js';
    import {GiveawayViewController} from '/js/controllers/giveawayViewController.js';

    let win = nw.Window.get();
    win.on('new-win-policy', function(frame, url, policy){
        policy.ignore();
        nw.Shell.openExternal( url );
    });
    win.setAlwaysOnTop(true);

    let appLifeCycleService = new AppLifeCycleService();
    let configSource = new ConfigSource("config.json", appLifeCycleService);
    let rankController = new RankController(configSource);
    let chatSource = new ChatSource(configSource, rankController);
    let rankedQueueService = new RankedQueueService("rankedQueue.json", appLifeCycleService, rankController);
    let giveawayService = new GiveawayService(rankController, chatSource);
    new CommandController(chatSource, rankController, rankedQueueService);
    let messageList = document.querySelector('#message_list');
    new ChatWindowViewController(messageList, chatSource, configSource);

    document.body.addEventListener('contextmenu', function(ev) {
        ev.preventDefault();
        let menu = new nw.Menu();
        let queueItem = new nw.MenuItem({ label: 'Очередь' });
        queueItem.click = function() {
            new RankedQueueViewController(rankedQueueService);
        };
        menu.append(queueItem);
        let giveawayItem = new nw.MenuItem({ label: 'Розыгрыш' });
        giveawayItem.click = function() {
            new GiveawayViewController(giveawayService);
        };
        menu.append(giveawayItem);
        menu.popup(ev.x, ev.y);
        return false;
    });
</script>
</body>
</html>