<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="css/default.css">    
    <title>MasterChat</title>
</head>
<body>
<div id="chat_container">
    <div id="channel_status_list"></div>
    <div id="message_list" class="big-smiles animated-smiles">
    </div>
</div>
<script id="message-template" type="text/x-handlebars-template">
    {{#if isSystem}}
    <div class='system_message'>{{{message}}}</div>
    {{else}}{{#if isError}}
    <div class='error_message'>{{{message}}}</div>
    {{else}}
    <div class='regular_message'>
        <div class='chat_logo {{chatLogo}}'></div>
        <img class='rank_icon' title='{{rankTitle}}' src='{{rankIcon}}'>
        <span class='nick username-normal'>{{nickname}}</span>
        <span{{#if isPersonal}} class='message-to-user'{{/if}}>{{{message}}}</span>
    </div>
    {{/if}}
    {{/if}}
</script>
<script type="module">
    import {AppLifeCycleService} from '/src/js/services/appLifeCycleService.js';
    import {ConfigService} from '/src/js/services/configService.js';
    import {RankController} from '/src/js/rankController.js';
    import {ChannelService} from '/src/js/services/channelService.js';
    import {MessageService} from '/src/js/services/messageService.js';
    import {ChannelStatusService} from '/src/js/services/channelStatusService.js';
    import {MessageListViewController} from '/src/js/controllers/messageListViewController.js';
    import {ChannelStatusViewController} from '/src/js/controllers/channelStatusViewController.js';
    import {CommandController} from '/src/js/commandController.js';
    import {RankedQueueService} from '/src/js/services/rankedQueueService.js';
    import {GiveawayService} from '/src/js/services/giveawayService.js';
    import {RankedQueueViewController} from '/src/js/controllers/rankQueueViewController.js';
    import {GiveawayViewController} from '/src/js/controllers/giveawayViewController.js';

    let win = nw.Window.get();
    win.on('new-win-policy', function(frame, url, policy){
        policy.ignore();
        nw.Shell.openExternal( url );
    });
    win.setAlwaysOnTop(true);

    const appLifeCycleService = new AppLifeCycleService();
    const configService = new ConfigService("config.json", appLifeCycleService);
    const channelService = new ChannelService(configService);
    const rankController = new RankController(configService);
    const messageService = new MessageService(channelService, rankController, configService);
    const channelStatusService = new ChannelStatusService(channelService);
    const rankedQueueService = new RankedQueueService("rankedQueue.json", appLifeCycleService, rankController);
    const giveawayService = new GiveawayService(messageService);
    new CommandController(messageService, rankController, rankedQueueService);
    const messageListView = document.getElementById('message_list');
    const messageTemplate = document.getElementById('message-template').innerHTML;
    new MessageListViewController(messageListView, messageService, messageTemplate, configService);
    const channelStatusListView = document.getElementById('channel_status_list');
    new ChannelStatusViewController(channelStatusListView, channelStatusService);

    document.body.addEventListener('contextmenu', function(ev) {
        ev.preventDefault();
        const menu = new nw.Menu();
        const queueItem = new nw.MenuItem({ label: 'Очередь' });
        queueItem.click = function() {
            new RankedQueueViewController(rankedQueueService);
        };
        menu.append(queueItem);
        const giveawayItem = new nw.MenuItem({ label: 'Розыгрыш' });
        giveawayItem.click = function() {
            new GiveawayViewController(giveawayService);
        };
        menu.append(giveawayItem);
        menu.popup(ev.x, ev.y);
        return false;
    });
</script>
</body>
</html>